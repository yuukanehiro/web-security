<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Authentication Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            font-family: 'Courier New', monospace;
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            background: #667eea;
            color: white;
            margin-right: 10px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #718096;
        }

        button.secondary:hover {
            background: #4a5568;
        }

        button.danger {
            background: #f56565;
        }

        button.danger:hover {
            background: #e53e3e;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background: #f0fff4;
            border: 1px solid #48bb78;
            color: #22543d;
        }

        .result.error {
            background: #fff5f5;
            border: 1px solid #f56565;
            color: #742a2a;
        }

        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .token-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            word-break: break-all;
        }

        .token-display h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .token-display code {
            display: block;
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.logged-in {
            background: #f0fff4;
            color: #22543d;
        }

        .status-badge.logged-out {
            background: #fff5f5;
            color: #742a2a;
        }

        .jwt-viewer {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .jwt-section {
            margin-bottom: 20px;
        }

        .jwt-section h4 {
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .jwt-header {
            background: #fed7d7;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f56565;
        }

        .jwt-payload {
            background: #d6bcfa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #9f7aea;
        }

        .jwt-signature {
            background: #bee3f8;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }

        .jwt-raw {
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            word-break: break-all;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .jwt-json {
            background: white;
            padding: 12px;
            border-radius: 4px;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .verify-section {
            margin-top: 15px;
            padding: 15px;
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 6px;
        }

        .verify-section.invalid {
            background: #fff5f5;
            border-color: #f56565;
        }

        .verify-section h4 {
            margin-bottom: 10px;
        }

        .verify-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .verify-input input {
            flex: 1;
        }

        .verify-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .verify-result.valid {
            background: #c6f6d5;
            color: #22543d;
        }

        .verify-result.invalid {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” JWT Authentication Test</h1>
        <p class="subtitle">JSON Web Token ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ•ãƒ«æ©Ÿèƒ½ç‰ˆï¼‰ã‚’ä½“é¨“</p>

        <div class="info-box">
            <strong>ğŸ’¡ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦:</strong><br>
            JWTèªè¨¼ã®å®Œå…¨ãªå®Ÿè£…ã‚’ä½“é¨“ã§ãã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã€RBACï¼ˆãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰ã‚’å­¦ã¹ã¾ã™ã€‚<br>
            <strong>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> user1/password1 (user), user2/password2 (user), admin/admin123 (admin)<br>
            <strong>æ©Ÿèƒ½:</strong> Access Token (15åˆ†) + Refresh Token (7æ—¥) + RBAC
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="section">
            <h2>èªè¨¼çŠ¶æ…‹ <span class="status-badge logged-out" id="auth-status">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­</span></h2>
            <div id="token-info"></div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
        <div class="section">
            <h2>1. ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆJWTãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰</h2>
            <div class="form-group">
                <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                <input type="text" id="username" value="user1" placeholder="user1">
            </div>
            <div class="form-group">
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="password" value="password1" placeholder="password1">
            </div>
            <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="danger" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <div id="login-result"></div>
        </div>

        <!-- ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ -->
        <div class="section">
            <h2>2. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼</h2>
            <p>ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹JWTãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™</p>
            <button class="secondary" onclick="validateToken()">ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼</button>
            <div id="validate-result"></div>
        </div>

        <!-- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ -->
        <div class="section">
            <h2>3. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§æ›´æ–°</h2>
            <p>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸéš›ã«ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™</p>
            <button class="secondary" onclick="refreshAccessToken()">ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°</button>
            <div id="refresh-result"></div>
        </div>

        <!-- ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ -->
        <div class="section">
            <h2>4. ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹</h2>
            <p>JWTèªè¨¼ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™</p>
            <button onclick="accessProtected()">ä¿è­·ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
            <button onclick="getMe()">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—</button>
            <div id="protected-result"></div>
        </div>

        <!-- ç®¡ç†è€…å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ -->
        <div class="section">
            <h2>5. ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½ï¼ˆRBACï¼‰</h2>
            <p>adminãƒ­ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</p>
            <button onclick="accessAdmin()">ç®¡ç†è€…ãƒ‘ãƒãƒ«ã¸ã‚¢ã‚¯ã‚»ã‚¹</button>
            <button onclick="listUsers()">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—</button>
            <div id="admin-result"></div>
        </div>

        <!-- ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ -->
        <div class="section">
            <h2>6. èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆï¼‰</h2>
            <p>JWTãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹ç¢ºèª</p>
            <button class="danger" onclick="accessWithoutToken()">ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹</button>
            <div id="no-token-result"></div>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ -->
        <div class="section">
            <h2>7. ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ†ã‚¹ãƒˆ</h2>
            <div class="form-group">
                <label for="custom-token">ã‚«ã‚¹ã‚¿ãƒ JWTãƒˆãƒ¼ã‚¯ãƒ³:</label>
                <textarea id="custom-token" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>
            </div>
            <button onclick="testCustomToken()">ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹</button>
            <div id="custom-result"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8090';

        // Base64URL ãƒ‡ã‚³ãƒ¼ãƒ‰
        function base64UrlDecode(str) {
            // Base64URL ã‚’ Base64 ã«å¤‰æ›
            let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
            // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ 
            while (base64.length % 4) {
                base64 += '=';
            }
            // ãƒ‡ã‚³ãƒ¼ãƒ‰
            try {
                return JSON.parse(decodeURIComponent(escape(atob(base64))));
            } catch (e) {
                return null;
            }
        }

        // JWT ã‚’ãƒ‘ãƒ¼ã‚¹
        function parseJWT(token) {
            const parts = token.split('.');
            if (parts.length !== 3) {
                return null;
            }

            return {
                header: base64UrlDecode(parts[0]),
                payload: base64UrlDecode(parts[1]),
                signature: parts[2],
                raw: {
                    header: parts[0],
                    payload: parts[1],
                    signature: parts[2]
                }
            };
        }

        // JWT ã‚’è¡¨ç¤ºï¼ˆjwt.io ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
        function displayJWT(token, containerId) {
            const container = document.getElementById(containerId);

            if (!token) {
                container.innerHTML = '<p style="color: #718096;">ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            const parsed = parseJWT(token);

            // JWTå½¢å¼ã§ãªã„å ´åˆï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ï¼‰
            if (!parsed) {
                container.innerHTML = `
                    <div class="jwt-viewer">
                        <div class="jwt-section">
                            <h4>ğŸ”‘ Random Token (Not JWT Format)</h4>
                            <div style="background: #bee3f8; padding: 15px; border-radius: 6px; border-left: 4px solid #4299e1;">
                                <div class="jwt-raw">${token}</div>
                                <p style="margin-top: 10px; color: #2c5282; font-size: 12px;">
                                    ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯JWTå½¢å¼ã§ã¯ãªãã€ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã•ã‚ŒãŸæ–‡å­—åˆ—ã§ã™ã€‚<br>
                                    ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢ã§ç®¡ç†ã•ã‚Œã€æ¤œè¨¼ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è¡Œã‚ã‚Œã¾ã™ã€‚
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // JWTå½¢å¼ã®å ´åˆ
            container.innerHTML = `
                <div class="jwt-viewer">
                    <div class="jwt-section">
                        <h4>ğŸ”´ Header (Algorithm & Token Type)</h4>
                        <div class="jwt-header">
                            <div class="jwt-raw">${parsed.raw.header}</div>
                            <div class="jwt-json">${JSON.stringify(parsed.header, null, 2)}</div>
                        </div>
                    </div>

                    <div class="jwt-section">
                        <h4>ğŸŸ£ Payload (Data/Claims)</h4>
                        <div class="jwt-payload">
                            <div class="jwt-raw">${parsed.raw.payload}</div>
                            <div class="jwt-json">${JSON.stringify(parsed.payload, null, 2)}</div>
                        </div>
                    </div>

                    <div class="jwt-section">
                        <h4>ğŸ”µ Signature</h4>
                        <div class="jwt-signature">
                            <div class="jwt-raw">${parsed.raw.signature}</div>
                        </div>
                    </div>

                    <div class="verify-section" id="verify-${containerId}">
                        <h4>ğŸ” Signature Verification</h4>
                        <div class="verify-input">
                            <input type="text" id="secret-${containerId}" placeholder="your-secret-key-change-this-in-production" value="your-secret-key-change-this-in-production">
                            <button onclick="verifyJWT('${containerId}')" class="secondary">æ¤œè¨¼</button>
                        </div>
                        <div id="verify-result-${containerId}"></div>
                    </div>
                </div>
            `;
        }

        // JWT ç½²åã‚’æ¤œè¨¼
        async function verifyJWT(containerId) {
            const token = containerId.includes('access')
                ? localStorage.getItem('jwt_access_token')
                : localStorage.getItem('jwt_refresh_token');

            if (!token) return;

            const secret = document.getElementById(`secret-${containerId}`).value;
            const resultDiv = document.getElementById(`verify-result-${containerId}`);

            if (!secret) {
                resultDiv.className = 'verify-result invalid';
                resultDiv.textContent = 'âŒ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }

            try {
                const parts = token.split('.');
                const header = parts[0];
                const payload = parts[1];
                const signature = parts[2];

                // HMAC-SHA256 ã§ç½²åã‚’è¨ˆç®—
                const encoder = new TextEncoder();
                const data = encoder.encode(`${header}.${payload}`);
                const keyData = encoder.encode(secret);

                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                const signatureBuffer = await crypto.subtle.sign('HMAC', cryptoKey, data);

                // Base64URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                const signatureArray = new Uint8Array(signatureBuffer);
                const signatureBase64 = btoa(String.fromCharCode(...signatureArray))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');

                if (signatureBase64 === signature) {
                    resultDiv.className = 'verify-result valid';
                    resultDiv.textContent = 'âœ… ç½²åãŒæœ‰åŠ¹ã§ã™ (Signature Verified)';
                    document.getElementById(`verify-${containerId}`).className = 'verify-section';
                } else {
                    resultDiv.className = 'verify-result invalid';
                    resultDiv.textContent = 'âŒ ç½²åãŒç„¡åŠ¹ã§ã™ (Invalid Signature)';
                    document.getElementById(`verify-${containerId}`).className = 'verify-section invalid';
                }
            } catch (error) {
                resultDiv.className = 'verify-result invalid';
                resultDiv.textContent = `âŒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                document.getElementById(`verify-${containerId}`).className = 'verify-section invalid';
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');

            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    throw new Error(`Login failed: ${response.status}`);
                }

                const data = await response.json();

                // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                localStorage.setItem('jwt_access_token', data.access_token);
                localStorage.setItem('jwt_refresh_token', data.refresh_token);
                localStorage.setItem('jwt_access_expires_at', data.access_token_expires_at);
                localStorage.setItem('jwt_refresh_expires_at', data.refresh_token_expires_at);
                localStorage.setItem('jwt_username', data.username);
                localStorage.setItem('jwt_role', data.role);

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ!</strong><br><br>
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${data.username}<br>
                    ãƒ­ãƒ¼ãƒ«: ${data.role}<br><br>
                    ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™: ${new Date(data.access_token_expires_at * 1000).toLocaleString()}<br>
                    ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™: ${new Date(data.refresh_token_expires_at * 1000).toLocaleString()}<br><br>
                    ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¸‹ã®ã€Œèªè¨¼çŠ¶æ…‹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                `;

                updateAuthStatus();
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            const refreshToken = localStorage.getItem('jwt_refresh_token');
            const accessToken = localStorage.getItem('jwt_access_token');

            // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ– & ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ 
            if (refreshToken) {
                try {
                    await fetch(`${API_URL}/api/logout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            refresh_token: refreshToken,
                            access_token: accessToken // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                        })
                    });
                } catch (error) {
                    console.error('Logout API error:', error);
                }
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            localStorage.removeItem('jwt_access_token');
            localStorage.removeItem('jwt_refresh_token');
            localStorage.removeItem('jwt_access_expires_at');
            localStorage.removeItem('jwt_refresh_expires_at');
            localStorage.removeItem('jwt_username');
            localStorage.removeItem('jwt_role');

            document.getElementById('login-result').className = 'result success';
            document.getElementById('login-result').textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼‰';

            updateAuthStatus();
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
        async function validateToken() {
            const resultDiv = document.getElementById('validate-result');
            const token = localStorage.getItem('jwt_access_token');

            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.innerHTML = 'æ¤œè¨¼ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/validate`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°
        async function refreshAccessToken() {
            const resultDiv = document.getElementById('refresh-result');
            const refreshToken = localStorage.getItem('jwt_refresh_token');

            if (!refreshToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.innerHTML = 'æ›´æ–°ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                if (!response.ok) {
                    throw new Error(`Refresh failed: ${response.status}`);
                }

                const data = await response.json();

                // æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                localStorage.setItem('jwt_access_token', data.access_token);
                localStorage.setItem('jwt_access_expires_at', data.access_token_expires_at);

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>âœ… ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°æˆåŠŸ!</strong><br><br>
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${data.username}<br>
                    ãƒ­ãƒ¼ãƒ«: ${data.role}<br>
                    æœ‰åŠ¹æœŸé™: ${new Date(data.access_token_expires_at * 1000).toLocaleString()}<br><br>
                    æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€Œèªè¨¼çŠ¶æ…‹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                `;

                updateAuthStatus();
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹
        async function accessProtected() {
            const resultDiv = document.getElementById('protected-result');
            const token = localStorage.getItem('jwt_access_token');

            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/protected`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        async function getMe() {
            const resultDiv = document.getElementById('protected-result');
            const token = localStorage.getItem('jwt_access_token');

            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æˆåŠŸ!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ å–å¾—å¤±æ•—\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ç®¡ç†è€…ãƒ‘ãƒãƒ«ã¸ã‚¢ã‚¯ã‚»ã‚¹
        async function accessAdmin() {
            const resultDiv = document.getElementById('admin-result');
            const token = localStorage.getItem('jwt_access_token');

            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/admin`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ (ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™)\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
        async function listUsers() {
            const resultDiv = document.getElementById('admin-result');
            const token = localStorage.getItem('jwt_access_token');

            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ (ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™)\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹
        async function accessWithoutToken() {
            const resultDiv = document.getElementById('no-token-result');
            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                const response = await fetch(`${API_URL}/api/protected`);
                const text = await response.text();

                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æœŸå¾…é€šã‚Šã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã•ã‚Œã¾ã—ãŸ\n\nStatus: ${response.status}\nResponse: ${text}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ†ã‚¹ãƒˆ
        async function testCustomToken() {
            const resultDiv = document.getElementById('custom-result');
            const customToken = document.getElementById('custom-token').value.trim();

            if (!customToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }

            resultDiv.innerHTML = 'é€ä¿¡ä¸­...';

            // Bearerãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
            const token = customToken.replace(/^Bearer\s+/i, '');

            try {
                const response = await fetch(`${API_URL}/api/protected`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
            }
        }

        // èªè¨¼çŠ¶æ…‹ã®æ›´æ–°
        function updateAuthStatus() {
            const accessToken = localStorage.getItem('jwt_access_token');
            const refreshToken = localStorage.getItem('jwt_refresh_token');
            const username = localStorage.getItem('jwt_username');
            const role = localStorage.getItem('jwt_role');
            const accessExpiresAt = localStorage.getItem('jwt_access_expires_at');
            const refreshExpiresAt = localStorage.getItem('jwt_refresh_expires_at');
            const statusBadge = document.getElementById('auth-status');
            const tokenInfo = document.getElementById('token-info');

            if (accessToken && username) {
                statusBadge.className = 'status-badge logged-in';
                statusBadge.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${username} (${role})`;

                const accessExpireDate = new Date(accessExpiresAt * 1000);
                const refreshExpireDate = new Date(refreshExpiresAt * 1000);
                const now = new Date();
                const isAccessExpired = accessExpireDate < now;
                const isRefreshExpired = refreshExpireDate < now;

                tokenInfo.innerHTML = `
                    <div class="token-display">
                        <h3>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
                            <span style="color: ${isAccessExpired ? '#e53e3e' : '#22543d'};">
                                ${isAccessExpired ? 'âŒ æœŸé™åˆ‡ã‚Œ' : 'âœ… æœ‰åŠ¹'}: ${accessExpireDate.toLocaleString()}
                            </span>
                        </h3>
                        <div id="access-token-viewer"></div>
                    </div>
                    <div class="token-display">
                        <h3>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³
                            <span style="color: ${isRefreshExpired ? '#e53e3e' : '#22543d'};">
                                ${isRefreshExpired ? 'âŒ æœŸé™åˆ‡ã‚Œ' : 'âœ… æœ‰åŠ¹'}: ${refreshExpireDate.toLocaleString()}
                            </span>
                        </h3>
                        <div id="refresh-token-viewer"></div>
                    </div>
                `;

                // JWT ã‚’è©³ç´°è¡¨ç¤º
                displayJWT(accessToken, 'access-token-viewer');
                displayJWT(refreshToken, 'refresh-token-viewer');
            } else {
                statusBadge.className = 'status-badge logged-out';
                statusBadge.textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­';
                tokenInfo.innerHTML = '';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°
        updateAuthStatus();

        console.log('ğŸ” JWT Authentication Test Tool Loaded');
        console.log('API URL:', API_URL);
    </script>
</body>
</html>
